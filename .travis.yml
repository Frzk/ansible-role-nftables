---
sudo: required
language: bash
services:
  - docker

# Build matrix
env:
#  - distribution: centos
#    version: 7
  - distribution: debian
    version: stretch
    

# Build a Docker image from the Dockerfile.${distribution}-${version} file
before_install:
  - docker pull "${distribution}:${version}"
  - docker build --no-cache --rm --file="travis/Dockerfile.${distribution}-${version}" --tag="${distribution}-${version}:ansible" travis

# Actually do the tests
script:
  #
  # 0/ Run the container
  - docker run --name "${TRAVIS_COMMIT}.${distribution}-${version}" --detach --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro --volume="${PWD}":/etc/ansible/roles/under_test:rw "${distribution}-${version}:ansible"
  #
  # 1/ Check role syntax:
  - docker exec "${TRAVIS_COMMIT}.${distribution}-${version}" env ANSIBLE_FORCE_COLOR=1 ansible-playbook -v /etc/ansible/roles/under_test/tests/test.yml --syntax-check
  #
  # 2/ Check first run:
  - docker exec "${TRAVIS_COMMIT}.${distribution}-${version}" env ANSIBLE_FORCE_COLOR=1 ansible-playbook -v /etc/ansible/roles/under_test/tests/test.yml --connection=local --become
  #
  # 3/ Check idempotence:
  - >
    docker exec "${TRAVIS_COMMIT}.${distribution}-${version}" env ANSIBLE_FORCE_COLOR=1 ansible-playbook -v /etc/ansible/roles/under_test/tests/test.yml --connection=local --become
    | grep -q 'changed=0.*failed=0'
    && (echo 'Idempotence test: pass' && exit 0)
    || (echo 'Idempotence test: fail' && exit 1)

after_script:
  # Remove container:
  - docker rm -f "${TRAVIS_COMMIT}.${distribution}-${version}"

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
...
